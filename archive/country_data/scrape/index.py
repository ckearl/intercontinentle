import requests as rq
from bs4 import BeautifulSoup
import populate_stats
from datetime import datetime as dt
import pandas as pd

BASE_URL = "https://www.cia.gov/the-world-factbook/countries/"
formatted_country_url_fragments = ["afghanistan", "akrotiri", "albania", "algeria", "american-samoa", "andorra", "angola", "anguilla", "antarctica", "antigua-and-barbuda", "argentina", "armenia", "aruba", "ashmore-and-cartier-islands", "australia", "austria", "azerbaijan", "bahamas-the", "bahrain", "baker-island", "bangladesh", "barbados", "belarus", "belgium", "belize", "benin", "bermuda", "bhutan", "bolivia", "bosnia-and-herzegovina", "botswana", "bouvet-island", "brazil", "british-indian-ocean-territory", "british-virgin-islands", "brunei", "bulgaria", "burkina-faso", "burma", "burundi", "cabo-verde", "cambodia", "cameroon", "canada", "cayman-islands", "central-african-republic", "chad", "chile", "china", "christmas-island", "clipperton-island", "cocos-keeling-islands", "colombia", "comoros", "congo-democratic-republic-of-the", "congo-republic-of-the", "cook-islands", "coral-sea-islands", "costa-rica", "cote-divoire", "croatia", "cuba", "curacao", "cyprus", "czechia", "denmark", "dhekelia", "djibouti", "dominica", "dominican-republic", "ecuador", "egypt", "el-salvador", "equatorial-guinea", "eritrea", "estonia", "eswatini", "ethiopia", "falkland-islands-islas-malvinas", "faroe-islands", "fiji", "finland", "france", "french-polynesia", "french-southern-and-antarctic-lands", "gabon", "gambia-the", "gaza-strip", "georgia", "germany", "ghana", "gibraltar", "greece", "greenland", "grenada", "guam", "guatemala", "guernsey", "guinea", "guinea-bissau", "guyana", "haiti", "heard-island-and-mcdonald-islands", "holy-see-vatican-city", "honduras", "hong-kong", "howland-island", "hungary", "iceland", "india", "indonesia", "iran", "iraq", "ireland", "isle-of-man", "israel", "italy", "jamaica", "jan-mayen", "japan", "jarvis-island", "jersey", "johnston-atoll", "jordan", "kazakhstan", "kenya", "kingman-reef", "kiribati", "korea-north", "korea-south", "kosovo", "kuwait", "kyrgyzstan", "laos", "latvia", "lebanon", "lesotho", "liberia", "libya", "liechtenstein", "lithuania", "luxembourg", "macau", "madagascar", "malawi", "malaysia", "maldives", "mali", "malta", "marshall-islands", "mauritania", "mauritius", "mexico", "micronesia-federated-states-of", "midway-islands", "moldova", "monaco", "mongolia", "montenegro", "montserrat", "morocco", "mozambique", "namibia", "nauru", "navassa-island", "nepal", "netherlands", "new-caledonia", "new-zealand", "nicaragua", "niger", "nigeria", "niue", "norfolk-island", "north-macedonia", "northern-mariana-islands", "norway", "oman", "pakistan", "palau", "palmyra-atoll", "panama", "papua-new-guinea", "paracel-islands", "paraguay", "peru", "philippines", "pitcairn-islands", "poland", "portugal", "puerto-rico", "qatar", "romania", "russia", "rwanda", "saint-barthelemy", "saint-helena-ascension-and-tristan-da-cunha", "saint-kitts-and-nevis", "saint-lucia", "saint-martin", "saint-pierre-and-miquelon", "saint-vincent-and-the-grenadines", "samoa", "san-marino", "sao-tome-and-principe", "saudi-arabia", "senegal", "serbia", "seychelles", "sierra-leone", "singapore", "sint-maarten", "slovakia", "slovenia", "solomon-islands", "somalia", "south-africa", "south-georgia-and-south-sandwich-islands", "south-sudan", "spain", "spratly-islands", "sri-lanka", "sudan", "suriname", "svalbard", "sweden", "switzerland", "syria", "taiwan", "tajikistan", "tanzania", "thailand", "timor-leste", "togo", "tokelau", "tonga", "trinidad-and-tobago", "tunisia", "turkey-turkiye", "turkmenistan", "turks-and-caicos-islands", "tuvalu", "uganda", "ukraine", "united-arab-emirates", "united-kingdom", "united-states", "united-states-pacific-island-wildlife-refuges", "uruguay", "uzbekistan", "vanuatu", "venezuela", "vietnam", "virgin-islands", "wake-island", "wallis-and-futuna", "west-bank", "world", "yemen", "zambia", "zimbabwe"]
official_country_names = {"afghanistan" : "Afghanistan", "akrotiri" : "Akrotiri", "albania" : "Albania", "algeria" : "Algeria", "american-samoa" : "American Samoa", "andorra" : "Andorra", "angola" : "Angola", "anguilla" : "Anguilla", "antarctica" : "Antarctica", "antigua-and-barbuda" : "Antigua and Barbuda", "argentina" : "Argentina", "armenia" : "Armenia", "aruba" : "Aruba", "ashmore-and-cartier-islands" : "Ashmore and Cartier Islands", "australia" : "Australia", "austria" : "Austria", "azerbaijan" : "Azerbaijan", "bahamas-the" : "Bahamas, The", "bahrain" : "Bahrain", "baker-island" : "Baker Island", "bangladesh" : "Bangladesh", "barbados" : "Barbados", "belarus" : "Belarus", "belgium" : "Belgium", "belize" : "Belize", "benin" : "Benin", "bermuda" : "Bermuda", "bhutan" : "Bhutan", "bolivia" : "Bolivia", "bosnia-and-herzegovina" : "Bosnia and Herzegovina", "botswana" : "Botswana", "bouvet-island" : "Bouvet Island", "brazil" : "Brazil", "british-indian-ocean-territory" : "British Indian Ocean Territory", "british-virgin-islands" : "British Virgin Islands", "brunei" : "Brunei", "bulgaria" : "Bulgaria", "burkina-faso" : "Burkina Faso", "burma" : "Burma", "burundi" : "Burundi", "cabo-verde" : "Cabo Verde", "cambodia" : "Cambodia", "cameroon" : "Cameroon", "canada" : "Canada", "cayman-islands" : "Cayman Islands", "central-african-republic" : "Central African Republic", "chad" : "Chad", "chile" : "Chile", "china" : "China", "christmas-island" : "Christmas Island", "clipperton-island" : "Clipperton Island", "cocos-keeling-islands" : "Cocos (Keeling) Islands", "colombia" : "Colombia", "comoros" : "Comoros", "congo-democratic-republic-of-the" : "Congo, Democratic Republic of the", "congo-republic-of-the" : "Congo, Republic of the", "cook-islands" : "Cook Islands", "coral-sea-islands" : "Coral Sea Islands", "costa-rica" : "Costa Rica", "cote-divoire" : "Cote d'Ivoire", "croatia" : "Croatia", "cuba" : "Cuba", "curacao" : "Curacao", "cyprus" : "Cyprus", "czechia" : "Czechia", "denmark" : "Denmark", "dhekelia" : "Dhekelia", "djibouti" : "Djibouti", "dominica" : "Dominica", "dominican-republic" : "Dominican Republic", "ecuador" : "Ecuador", "egypt" : "Egypt", "el-salvador" : "El Salvador", "equatorial-guinea" : "Equatorial Guinea", "eritrea" : "Eritrea", "estonia" : "Estonia", "eswatini" : "Eswatini", "ethiopia" : "Ethiopia", "falkland-islands-islas-malvinas" : "Falkland Islands (Islas Malvinas)", "faroe-islands" : "Faroe Islands", "fiji" : "Fiji", "finland" : "Finland", "france" : "France", "french-polynesia" : "French Polynesia", "french-southern-and-antarctic-lands" : "French Southern and Antarctic Lands", "gabon" : "Gabon", "gambia-the" : "Gambia, The", "gaza-strip" : "Gaza Strip", "georgia" : "Georgia", "germany" : "Germany", "ghana" : "Ghana", "gibraltar" : "Gibraltar", "greece" : "Greece", "greenland" : "Greenland", "grenada" : "Grenada", "guam" : "Guam", "guatemala" : "Guatemala", "guernsey" : "Guernsey", "guinea" : "Guinea", "guinea-bissau" : "Guinea-Bissau", "guyana" : "Guyana", "haiti" : "Haiti", "heard-island-and-mcdonald-islands" : "Heard Island and McDonald Islands", "holy-see-vatican-city" : "Holy See (Vatican City)", "honduras" : "Honduras", "hong-kong" : "Hong Kong", "howland-island" : "Howland Island", "hungary" : "Hungary", "iceland" : "Iceland", "india" : "India", "indonesia" : "Indonesia", "iran" : "Iran", "iraq" : "Iraq", "ireland" : "Ireland", "isle-of-man" : "Isle of Man", "israel" : "Israel", "italy" : "Italy", "jamaica" : "Jamaica", "jan-mayen" : "Jan Mayen", "japan" : "Japan", "jarvis-island" : "Jarvis Island", "jersey" : "Jersey", "johnston-atoll" : "Johnston Atoll", "jordan" : "Jordan", "kazakhstan" : "Kazakhstan", "kenya" : "Kenya", "kingman-reef" : "Kingman Reef", "kiribati" : "Kiribati", "korea-north" : "Korea, North", "korea-south" : "Korea, South", "kosovo" : "Kosovo", "kuwait" : "Kuwait", "kyrgyzstan" : "Kyrgyzstan", "laos" : "Laos", "latvia" : "Latvia", "lebanon" : "Lebanon", "lesotho" : "Lesotho", "liberia" : "Liberia", "libya" : "Libya", "liechtenstein" : "Liechtenstein", "lithuania" : "Lithuania", "luxembourg" : "Luxembourg", "macau" : "Macau", "madagascar" : "Madagascar", "malawi" : "Malawi", "malaysia" : "Malaysia", "maldives" : "Maldives", "mali" : "Mali", "malta" : "Malta", "marshall-islands" : "Marshall Islands", "mauritania" : "Mauritania", "mauritius" : "Mauritius", "mexico" : "Mexico", "micronesia-federated-states-of" : "Micronesia, Federated States of", "midway-islands" : "Midway Islands", "moldova" : "Moldova", "monaco" : "Monaco", "mongolia" : "Mongolia", "montenegro" : "Montenegro", "montserrat" : "Montserrat", "morocco" : "Morocco", "mozambique" : "Mozambique", "namibia" : "Namibia", "nauru" : "Nauru", "navassa-island" : "Navassa Island", "nepal" : "Nepal", "netherlands" : "Netherlands", "new-caledonia" : "New Caledonia", "new-zealand" : "New Zealand", "nicaragua" : "Nicaragua", "niger" : "Niger", "nigeria" : "Nigeria", "niue" : "Niue", "norfolk-island" : "Norfolk Island", "north-macedonia" : "North Macedonia", "northern-mariana-islands" : "Northern Mariana Islands", "norway" : "Norway", "oman" : "Oman", "pakistan" : "Pakistan", "palau" : "Palau", "palmyra-atoll" : "Palmyra Atoll", "panama" : "Panama", "papua-new-guinea" : "Papua New Guinea", "paracel-islands" : "Paracel Islands", "paraguay" : "Paraguay", "peru" : "Peru", "philippines" : "Philippines", "pitcairn-islands" : "Pitcairn Islands", "poland" : "Poland", "portugal" : "Portugal", "puerto-rico" : "Puerto Rico", "qatar" : "Qatar", "romania" : "Romania", "russia" : "Russia", "rwanda" : "Rwanda", "saint-barthelemy" : "Saint Barthelemy", "saint-helena-ascension-and-tristan-da-cunha" : "Saint Helena, Ascension, and Tristan da Cunha", "saint-kitts-and-nevis" : "Saint Kitts and Nevis", "saint-lucia" : "Saint Lucia", "saint-martin" : "Saint Martin", "saint-pierre-and-miquelon" : "Saint Pierre and Miquelon", "saint-vincent-and-the-grenadines" : "Saint Vincent and the Grenadines", "samoa" : "Samoa", "san-marino" : "San Marino", "sao-tome-and-principe" : "Sao Tome and Principe", "saudi-arabia" : "Saudi Arabia", "senegal" : "Senegal", "serbia" : "Serbia", "seychelles" : "Seychelles", "sierra-leone" : "Sierra Leone", "singapore" : "Singapore", "sint-maarten" : "Sint Maarten", "slovakia" : "Slovakia", "slovenia" : "Slovenia", "solomon-islands" : "Solomon Islands", "somalia" : "Somalia", "south-africa" : "South Africa", "south-georgia-and-south-sandwich-islands" : "South Georgia and South Sandwich Islands", "south-sudan" : "South Sudan", "spain" : "Spain", "spratly-islands" : "Spratly Islands", "sri-lanka" : "Sri Lanka", "sudan" : "Sudan", "suriname" : "Suriname", "svalbard" : "Svalbard", "sweden" : "Sweden", "switzerland" : "Switzerland", "syria" : "Syria", "taiwan" : "Taiwan", "tajikistan" : "Tajikistan", "tanzania" : "Tanzania", "thailand" : "Thailand", "timor-leste" : "Timor-Leste", "togo" : "Togo", "tokelau" : "Tokelau", "tonga" : "Tonga", "trinidad-and-tobago" : "Trinidad and Tobago", "tunisia" : "Tunisia", "turkey-turkiye" : "Turkey (Turkiye)", "turkmenistan" : "Turkmenistan", "turks-and-caicos-islands" : "Turks and Caicos Islands", "tuvalu" : "Tuvalu", "uganda" : "Uganda", "ukraine" : "Ukraine", "united-arab-emirates" : "United Arab Emirates", "united-kingdom" : "United Kingdom", "united-states" : "United States", "united-states-pacific-island-wildlife-refuges" : "United States Pacific Island Wildlife Refuges", "uruguay" : "Uruguay", "uzbekistan" : "Uzbekistan", "vanuatu" : "Vanuatu", "venezuela" : "Venezuela", "vietnam" : "Vietnam", "virgin-islands" : "Virgin Islands", "wake-island" : "Wake Island", "wallis-and-futuna" : "Wallis and Futuna", "west-bank" : "West Bank", "world" : "World", "yemen" : "Yemen", "zambia" : "Zambia", "zimbabwe" : "Zimbabwe"}

# baker-island, british-indian-ocean-territory, dhekelia

countries = {}
print(dt.now())
country_url = ""

for country in formatted_country_url_fragments:
    country_url = BASE_URL + country
    response = rq.get(country_url)
    soup = BeautifulSoup(response.text, "html.parser")

    geography_div = soup.find("div", {"id" : "geography"})
    geography_stats_dict = populate_stats.geography_stats(geography_div)

    people_and_society_div = soup.find("div", {"id" : "people-and-society"})
    people_and_society_stats_dict = populate_stats.people_and_society_stats(people_and_society_div)

    government_div = soup.find("div", {"id" : "government"})
    government_stats_dict = populate_stats.government_stats(government_div)

    economy_div = soup.find("div", {"id" : "economy"})
    economy_stats_dict = populate_stats.economy_stats(economy_div)

    energy_div = soup.find("div", {"id" : "energy"})
    energy_stats_dict = populate_stats.energy_stats(energy_div)

    communications_div = soup.find("div", {"id" : "communications"})
    communications_stats_dict = populate_stats.communications_stats(communications_div)

    countries = populate_stats.populate_countries_dict(countries, country, official_country_names, geography_stats_dict, people_and_society_stats_dict, government_stats_dict, economy_stats_dict, energy_stats_dict, communications_stats_dict)
    print(f'Finished {country}')

for country in countries:
    # print(f'{country} : {countries[country]}')
    # if number of empty values is greater than 3, remove that country from the dictionary
    if len(countries[country]) - countries[country].count("") > 3:
        countries.pop(country)
        print(f"Removed {country} from the dictionary")

print("Converting to dataframe and exporting to csv...")
countries_df = pd.DataFrame(countries)
countries_df = countries_df.transpose()

countries_df.to_csv("countries.csv")